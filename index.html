<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الإدمن - إدارة المتجر الإلكتروني</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .header h1 {
            color: #2c3e50;
            font-size: 2rem;
            font-weight: 700;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
        }
        .nav-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .nav-tab {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .nav-tab:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        .nav-tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
        }
        .content-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .content-section.active {
            display: block;
            animation: fadeInUp 0.5s ease;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .login-section {
            max-width: 400px;
            margin: 50px auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transform: translateY(0);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .metric-card:hover::before {
            left: 100%;
        }
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }
        .metric-card h3 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .metric-card p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        .revenue-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        .revenue-card.pending {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }
        .revenue-card.cancelled {
            background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
        }
        .orders-container {
            margin-top: 20px;
        }
        .order-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 8px 15px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .filter-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        .filter-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }
        .orders-grid {
            display: grid;
            gap: 20px;
        }
        .order-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 5px solid #667eea;
        }
        .order-card.pending {
            border-left-color: #ffc107;
        }
        .order-card.processing {
            border-left-color: #17a2b8;
        }
        .order-card.shipped {
            border-left-color: #fd7e14;
        }
        .order-card.delivered {
            border-left-color: #28a745;
        }
        .order-card.cancelled {
            border-left-color: #dc3545;
        }
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .order-id {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
        }
        .order-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-processing {
            background: #d1ecf1;
            color: #0c5460;
        }
        .status-shipped {
            background: #fff3cd;
            color: #856404;
        }
        .status-delivered {
            background: #d4edda;
            color: #155724;
        }
        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }
        .customer-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .customer-info h4 {
            color: #495057;
            margin-bottom: 10px;
        }
        .customer-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 14px;
        }
        .order-items {
            margin-bottom: 15px;
        }
        .order-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .order-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }
        .item-details {
            flex: 1;
        }
        .item-name {
            font-weight: 600;
            color: #2c3e50;
        }
        .item-info {
            font-size: 14px;
            color: #6c757d;
            margin-top: 5px;
        }
        .order-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .order-total {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 700;
            color: #28a745;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .revenue-analytics {
            margin-top: 30px;
        }
        .revenue-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .revenue-chart {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .loading.show {
            display: block;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .connection-status.connected {
            background: #28a745;
            color: white;
        }
        .connection-status.disconnected {
            background: #dc3545;
            color: white;
        }
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .product-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .product-info h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        .product-price {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        .new-price {
            color: #28a745;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .old-price {
            color: #6c757d;
            text-decoration: line-through;
        }
        .product-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .users-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }
        .user-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .user-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
        }
        .user-role {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .role-admin {
            background: #dc3545;
            color: white;
        }
        .role-manager {
            background: #17a2b8;
            color: white;
        }
        .role-support {
            background: #6c757d;
            color: white;
        }
        .role-user {
            background: #28a745;
            color: white;
        }
        .user-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 14px;
        }
        .user-detail {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .add-product-form {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .hero-section-form {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 10px;
        }
        .add-staff-form {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .checkout-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .checkout-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .cart-summary {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .cart-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .cart-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
        }
        .item-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-in-cart {
            background: #fff3cd;
            color: #856404;
        }
        .status-checkedout {
            background: #d4edda;
            color: #155724;
        }
        .captcha-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .captcha-image {
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .captcha-refresh {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .captcha-refresh:hover {
            background: #e9ecef;
        }
        
        /* Activity Panel Styles */
        .activity-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .activity-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .activity-table th,
        .activity-table td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        .activity-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        .activity-table tr:hover {
            background: #f8f9ff;
        }
        .activity-action {
            font-weight: 600;
            color: #667eea;
        }
        .activity-admin {
            color: #2c3e50;
        }
        .activity-time {
            color: #6c757d;
            font-size: 14px;
        }
        
        /* Notification Center Styles */
        .notification-center {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .notification-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .notification-item:hover {
            background: #f8f9ff;
        }
        .notification-item.unread {
            background: #f0f7ff;
            border-left: 4px solid #667eea;
        }
        .notification-icon {
            font-size: 1.2rem;
            margin-top: 2px;
        }
        .notification-icon.info {
            color: #17a2b8;
        }
        .notification-icon.success {
            color: #28a745;
        }
        .notification-icon.warning {
            color: #ffc107;
        }
        .notification-icon.error {
            color: #dc3545;
        }
        .notification-content {
            flex: 1;
        }
        .notification-message {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .notification-time {
            color: #6c757d;
            font-size: 14px;
        }
        .notification-mark-read {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        .notification-mark-read:hover {
            background: #f0f7ff;
        }
        
        /* Payment Buttons Styles */
        .payment-options {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .payment-button {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .payment-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }
        .payment-button.stripe {
            border-color: #635bff;
        }
        .payment-button.stripe:hover {
            background: #635bff;
            color: white;
        }
        .payment-button.paypal {
            border-color: #0070ba;
        }
        .payment-button.paypal:hover {
            background: #0070ba;
            color: white;
        }
        .payment-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .payment-button.stripe .payment-icon {
            color: #635bff;
        }
        .payment-button.paypal .payment-icon {
            color: #0070ba;
        }
        .payment-button:hover .payment-icon {
            color: white;
        }
        .payment-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .payment-desc {
            font-size: 14px;
            color: #6c757d;
        }
        
        @media (max-width: 768px) {
            .admin-container {
                padding: 10px;
            }
            .header {
                flex-direction: column;
                text-align: center;
            }
            .header h1 {
                font-size: 1.5rem;
            }
            .nav-tabs {
                justify-content: center;
            }
            .products-grid {
                grid-template-columns: 1fr;
            }
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            .product-actions {
                flex-direction: column;
            }
            .order-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .customer-details {
                grid-template-columns: 1fr;
            }
            .user-details {
                grid-template-columns: 1fr;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .captcha-container {
                flex-direction: column;
                align-items: flex-start;
            }
            .activity-table {
                font-size: 14px;
            }
            .activity-table th,
            .activity-table td {
                padding: 8px 10px;
            }
            .payment-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="connection-status connected">
        <i class="fas fa-wifi"></i> متصل
    </div>
    
    <div class="admin-container">
        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">
                <i class="fas fa-shield-alt"></i> دخول الإدمن
            </h2>
            <div id="loginAlert"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">البريد الإلكتروني:</label>
                    <input type="email" id="email" name="email" required placeholder="admin@example.com">
                </div>
                <div class="form-group">
                    <label for="password">كلمة المرور:</label>
                    <input type="password" id="password" name="password" required placeholder="كلمة المرور">
                </div>
                <div class="form-group">
                    <label>التحقق من الإنسان (CAPTCHA):</label>
                    <div class="captcha-container">
                        <img id="captchaImage" class="captcha-image" src="" alt="CAPTCHA">
                        <button type="button" class="captcha-refresh" onclick="refreshCaptcha()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <input type="text" id="captcha" name="captcha" required placeholder="أدخل النص الظاهر في الصورة">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> دخول
                </button>
            </form>
        </div>
        
        <!-- Admin Dashboard -->
        <div id="adminDashboard" style="display: none;">
            <div class="header">
                <h1><i class="fas fa-tachometer-alt"></i> لوحة تحكم المتجر الإلكتروني</h1>
                <div class="user-info">
                    <i class="fas fa-user-shield"></i>
                    <span id="adminName">الإدمن</span>
                    <button onclick="logout()" class="btn" style="background: rgba(255,255,255,0.2); color: white; padding: 8px 15px;">
                        <i class="fas fa-sign-out-alt"></i> خروج
                    </button>
                </div>
            </div>
            
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showSection('dashboard')">
                    <i class="fas fa-chart-pie"></i> الإحصائيات
                </button>
                <button class="nav-tab" onclick="showSection('orders')">
                    <i class="fas fa-shopping-cart"></i> الطلبات
                </button>
                <button class="nav-tab" onclick="showSection('checkout')">
                    <i class="fas fa-credit-card"></i> الدفع
                </button>
                <button class="nav-tab" onclick="showSection('products')">
                    <i class="fas fa-box"></i> المنتجات
                </button>
                <button class="nav-tab" onclick="showSection('addProduct')">
                    <i class="fas fa-plus-circle"></i> إضافة منتج
                </button>
                <button class="nav-tab" onclick="showSection('users')">
                    <i class="fas fa-users"></i> المستخدمين
                </button>
                <button class="nav-tab" onclick="showSection('addStaff')">
                    <i class="fas fa-user-plus"></i> إضافة موظف
                </button>
                <button class="nav-tab" onclick="showSection('revenue')">
                    <i class="fas fa-chart-line"></i> تحليل الإيرادات
                </button>
                <button class="nav-tab" onclick="showSection('heroSection')">
                    <i class="fas fa-image"></i> قسم البطل
                </button>
                <button class="nav-tab" onclick="showSection('activityLogs')">
                    <i class="fas fa-history"></i> سجل الأنشطة
                </button>
                <button class="nav-tab" onclick="showSection('notifications')">
                    <i class="fas fa-bell"></i> الإشعارات
                </button>
            </div>
            
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <h2 style="margin-bottom: 20px; color: #2c3e50;">
                    <i class="fas fa-chart-line"></i> إحصائيات المتجر
                </h2>
                <div class="metrics-grid" id="metricsContainer">
                    <div class="loading show">
                        <div class="spinner"></div>
                        <p>جاري تحميل الإحصائيات...</p>
                    </div>
                </div>
            </div>
            
            <!-- Orders Section -->
            <div id="orders" class="content-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="color: #2c3e50;">
                        <i class="fas fa-clipboard-list"></i> إدارة الطلبات
                    </h2>
                    <button onclick="loadOrders()" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i> تحديث
                    </button>
                </div>
                
                <div class="order-filters">
                    <button class="filter-btn active" data-status="all" onclick="filterOrders('all', this)">
                        <i class="fas fa-list"></i> جميع الطلبات
                    </button>
                    <button class="filter-btn" data-status="pending" onclick="filterOrders('pending', this)">
                        <i class="fas fa-clock"></i> قيد الانتظار
                    </button>
                    <button class="filter-btn" data-status="processing" onclick="filterOrders('processing', this)">
                        <i class="fas fa-cogs"></i> قيد المعالجة
                    </button>
                    <button class="filter-btn" data-status="shipped" onclick="filterOrders('shipped', this)">
                        <i class="fas fa-truck"></i> تم الشحن
                    </button>
                    <button class="filter-btn" data-status="delivered" onclick="filterOrders('delivered', this)">
                        <i class="fas fa-check-circle"></i> تم التسليم
                    </button>
                    <button class="filter-btn" data-status="cancelled" onclick="filterOrders('cancelled', this)">
                        <i class="fas fa-times-circle"></i> ملغية
                    </button>
                </div>
                
                <div id="ordersContainer" class="orders-container">
                    <div class="loading show">
                        <div class="spinner"></div>
                        <p>جاري تحميل الطلبات...</p>
                    </div>
                </div>
            </div>
            
            <!-- Checkout Section -->
            <div id="checkout" class="content-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="color: #2c3e50;">
                        <i class="fas fa-credit-card"></i> عملية الدفع
                    </h2>
                    <button onclick="loadCartData()" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i> تحديث السلة
                    </button>
                </div>
                
                <div class="checkout-section">
                    <div id="checkoutAlert"></div>
                    
                    <div class="cart-summary" id="cartSummary">
                        <div class="loading show">
                            <div class="spinner"></div>
                            <p>جاري تحميل بيانات السلة...</p>
                        </div>
                    </div>
                    
                    <div class="checkout-form">
                        <h3 style="margin-bottom: 20px; color: #2c3e50;">
                            <i class="fas fa-credit-card"></i> معلومات الدفع
                        </h3>
                        <form id="checkoutForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="paymentMethod">طريقة الدفع: <span style="color: red;">*</span></label>
                                    <select id="paymentMethod" name="paymentMethod" required>
                                        <option value="">اختر طريقة الدفع</option>
                                        <option value="cash_on_delivery">الدفع عند الاستلام</option>
                                        <option value="bank_transfer">تحويل بنكي</option>
                                        <option value="stripe">Stripe</option>
                                        <option value="paypal">PayPal</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="checkoutPhone">رقم الهاتف: <span style="color: red;">*</span></label>
                                    <input type="tel" id="checkoutPhone" name="phone" required placeholder="أدخل رقم الهاتف">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="checkoutAddress">العنوان: <span style="color: red;">*</span></label>
                                    <input type="text" id="checkoutAddress" name="address" required placeholder="أدخل العنوان">
                                </div>
                                <div class="form-group">
                                    <label for="checkoutGovernorate">المحافظة: <span style="color: red;">*</span></label>
                                    <input type="text" id="checkoutGovernorate" name="governorate" required placeholder="أدخل المحافظة">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>التحقق من الإنسان (CAPTCHA):</label>
                                <div class="captcha-container">
                                    <img id="checkoutCaptchaImage" class="captcha-image" src="" alt="CAPTCHA">
                                    <button type="button" class="captcha-refresh" onclick="refreshCheckoutCaptcha()">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                                <input type="text" id="checkoutCaptcha" name="captcha" required placeholder="أدخل النص الظاهر في الصورة">
                            </div>
                            
                            <button type="submit" class="btn btn-success" style="width: 100%; margin-top: 20px;">
                                <i class="fas fa-credit-card"></i> إتمام الدفع
                            </button>
                        </form>
                    </div>
                    
                    <!-- Payment Options -->
                    <div class="payment-options">
                        <div class="payment-button stripe" onclick="handleStripePayment()">
                            <div class="payment-icon">
                                <i class="fab fa-stripe"></i>
                            </div>
                            <div class="payment-title">Stripe</div>
                            <div class="payment-desc">دفع آمن بالبطاقة</div>
                        </div>
                        <div class="payment-button paypal" onclick="handlePayPalPayment()">
                            <div class="payment-icon">
                                <i class="fab fa-paypal"></i>
                            </div>
                            <div class="payment-title">PayPal</div>
                            <div class="payment-desc">دفع عبر PayPal</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Products Section -->
            <div id="products" class="content-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="color: #2c3e50;">
                        <i class="fas fa-box-open"></i> إدارة المنتجات
                    </h2>
                    <button onclick="loadProducts()" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i> تحديث
                    </button>
                </div>
                
                <div id="productsContainer">
                    <div class="loading show">
                        <div class="spinner"></div>
                        <p>جاري تحميل المنتجات...</p>
                    </div>
                </div>
            </div>
            
            <!-- Add Product Section -->
            <div id="addProduct" class="content-section">
                <h2 style="margin-bottom: 20px; color: #2c3e50;">
                    <i class="fas fa-plus-square"></i> إضافة منتج جديد
                </h2>
                
                <div class="add-product-form">
                    <div id="addProductAlert"></div>
                    <form id="addProductForm" enctype="multipart/form-data">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productName">اسم المنتج: <span style="color: red;">*</span></label>
                                <input type="text" id="productName" name="name" required placeholder="أدخل اسم المنتج">
                            </div>
                            <div class="form-group">
                                <label for="productTitle">العنوان:</label>
                                <input type="text" id="productTitle" name="title" placeholder="عنوان المنتج (اختياري)">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productCategory">الفئة: <span style="color: red;">*</span></label>
                                <select id="productCategory" name="category" required>
                                    <option value="">اختر الفئة</option>
                                    <option value="men">رجالي</option>
                                    <option value="women">نسائي</option>
                                    <option value="kid">أطفال</option>
                                    <option value="electronics">إلكترونيات</option>
                                    <option value="accessories">إكسسوارات</option>
                                    <option value="shoes">أحذية</option>
                                    <option value="bags">حقائب</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="productNewPrice">السعر الجديد (ج.م): <span style="color: red;">*</span></label>
                                <input type="number" id="productNewPrice" name="new_price" step="0.01" required placeholder="0.00">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productOldPrice">السعر القديم (ج.م):</label>
                                <input type="number" id="productOldPrice" name="old_price" step="0.01" placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label>المقاسات المتاحة: <span style="color: red;">*</span></label>
                                <div id="sizesContainer" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px;">
                                    <div style="display: flex; align-items: center;">
                                        <input type="checkbox" id="sizeXS" name="sizes" value="XS" checked>
                                        <label for="sizeXS" style="margin: 0 5px;">XS</label>
                                    </div>
                                    <div style="display: flex; align-items: center;">
                                        <input type="checkbox" id="sizeS" name="sizes" value="S" checked>
                                        <label for="sizeS" style="margin: 0 5px;">S</label>
                                    </div>
                                    <div style="display: flex; align-items: center;">
                                        <input type="checkbox" id="sizeM" name="sizes" value="M" checked>
                                        <label for="sizeM" style="margin: 0 5px;">M</label>
                                    </div>
                                    <div style="display: flex; align-items: center;">
                                        <input type="checkbox" id="sizeL" name="sizes" value="L" checked>
                                        <label for="sizeL" style="margin: 0 5px;">L</label>
                                    </div>
                                    <div style="display: flex; align-items: center;">
                                        <input type="checkbox" id="sizeXL" name="sizes" value="XL" checked>
                                        <label for="sizeXL" style="margin: 0 5px;">XL</label>
                                    </div>
                                    <div style="display: flex; align-items: center;">
                                        <input type="checkbox" id="sizeXXL" name="sizes" value="XXL" checked>
                                        <label for="sizeXXL" style="margin: 0 5px;">XXL</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="productDescription">الوصف:</label>
                            <textarea id="productDescription" name="description" rows="4" placeholder="وصف المنتج (اختياري)"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>صورة المنتج:</label>
                            <div class="upload-area" id="uploadArea" style="border: 2px dashed #667eea; border-radius: 10px; padding: 40px; text-align: center; background: #f8f9ff; cursor: pointer; transition: all 0.3s ease; margin-bottom: 10px;" onclick="document.getElementById('productImage').click()">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #667eea; margin-bottom: 15px;"></i>
                                <p style="margin-bottom: 10px; font-weight: 600;">اضغط لاختيار صورة أو اسحب الصورة هنا</p>
                                <p style="color: #6c757d; font-size: 14px;">يدعم: JPG, PNG, GIF (الحد الأقصى 5MB)</p>
                                <input type="file" id="productImage" name="image" accept="image/*" style="display: none;">
                            </div>
                            <div id="imagePreview"></div>
                        </div>
                        
                        <button type="submit" class="btn btn-success" style="width: 100%; margin-top: 20px;">
                            <i class="fas fa-plus"></i> إضافة المنتج
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Users Section -->
            <div id="users" class="content-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="color: #2c3e50;">
                        <i class="fas fa-users-cog"></i> إدارة المستخدمين
                    </h2>
                    <button onclick="loadUsers()" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i> تحديث
                    </button>
                </div>
                
                <div id="usersContainer" class="users-grid">
                    <div class="loading show">
                        <div class="spinner"></div>
                        <p>جاري تحميل المستخدمين...</p>
                    </div>
                </div>
            </div>
            
            <!-- Add Staff Section -->
            <div id="addStaff" class="content-section">
                <h2 style="margin-bottom: 20px; color: #2c3e50;">
                    <i class="fas fa-user-plus"></i> إضافة موظف جديد
                </h2>
                
                <div class="add-staff-form">
                    <div id="addStaffAlert"></div>
                    <form id="addStaffForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="staffFullName">الاسم الكامل: <span style="color: red;">*</span></label>
                                <input type="text" id="staffFullName" name="fullName" required placeholder="أدخل الاسم الكامل">
                            </div>
                            <div class="form-group">
                                <label for="staffEmail">البريد الإلكتروني: <span style="color: red;">*</span></label>
                                <input type="email" id="staffEmail" name="email" required placeholder="أدخل البريد الإلكتروني">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="staffPassword">كلمة المرور: <span style="color: red;">*</span></label>
                                <input type="password" id="staffPassword" name="password" required placeholder="أدخل كلمة المرور">
                            </div>
                            <div class="form-group">
                                <label for="staffRole">الدور: <span style="color: red;">*</span></label>
                                <select id="staffRole" name="role" required>
                                    <option value="">اختر الدور</option>
                                    <option value="admin">مدير</option>
                                    <option value="manager">مدير قسم</option>
                                    <option value="support">دعم فني</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="staffPhone">رقم الهاتف:</label>
                                <input type="tel" id="staffPhone" name="phone" placeholder="أدخل رقم الهاتف">
                            </div>
                            <div class="form-group">
                                <label for="staffAddress">العنوان:</label>
                                <input type="text" id="staffAddress" name="address" placeholder="أدخل العنوان">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="staffGovernorate">المحافظة:</label>
                            <input type="text" id="staffGovernorate" name="governorate" placeholder="أدخل المحافظة">
                        </div>
                        
                        <button type="submit" class="btn btn-success" style="width: 100%; margin-top: 20px;">
                            <i class="fas fa-user-plus"></i> إضافة الموظف
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Revenue Analytics Section -->
            <div id="revenue" class="content-section">
                <h2 style="margin-bottom: 20px; color: #2c3e50;">
                    <i class="fas fa-chart-bar"></i> تحليل الإيرادات
                </h2>
                
                <div class="revenue-filters">
                    <button class="filter-btn active" onclick="loadRevenue('daily', this)">
                        <i class="fas fa-calendar-day"></i> يومي
                    </button>
                    <button class="filter-btn" onclick="loadRevenue('monthly', this)">
                        <i class="fas fa-calendar-alt"></i> شهري
                    </button>
                    <button class="filter-btn" onclick="loadRevenue('yearly', this)">
                        <i class="fas fa-calendar"></i> سنوي
                    </button>
                </div>
                
                <div id="revenueContainer" class="revenue-analytics">
                    <div class="loading show">
                        <div class="spinner"></div>
                        <p>جاري تحميل تحليل الإيرادات...</p>
                    </div>
                </div>
            </div>
            
            <!-- Hero Section Management -->
            <div id="heroSection" class="content-section">
                <h2 style="margin-bottom: 20px; color: #2c3e50;">
                    <i class="fas fa-image"></i> إدارة قسم البطل
                </h2>
                
                <div class="hero-section-form">
                    <div id="heroAlert"></div>
                    <form id="heroForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="heroTitle">العنوان الرئيسي: <span style="color: red;">*</span></label>
                                <input type="text" id="heroTitle" name="title" required placeholder="أدخل العنوان الرئيسي">
                            </div>
                            <div class="form-group">
                                <label for="heroSubtitle">العنوان الفرعي: <span style="color: red;">*</span></label>
                                <input type="text" id="heroSubtitle" name="subtitle" required placeholder="أدخل العنوان الفرعي">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="heroButtonText">نص الزر: <span style="color: red;">*</span></label>
                                <input type="text" id="heroButtonText" name="buttonText" required placeholder="أدخل نص الزر">
                            </div>
                            <div class="form-group">
                                <label for="heroButtonLink">رابط الزر: <span style="color: red;">*</span></label>
                                <input type="text" id="heroButtonLink" name="buttonLink" required placeholder="أدخل رابط الزر">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>صورة الخلفية: <span style="color: red;">*</span></label>
                            <div class="upload-area" id="heroUploadArea" style="border: 2px dashed #667eea; border-radius: 10px; padding: 40px; text-align: center; background: #f8f9ff; cursor: pointer; transition: all 0.3s ease; margin-bottom: 10px;" onclick="document.getElementById('heroBackgroundImage').click()">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #667eea; margin-bottom: 15px;"></i>
                                <p style="margin-bottom: 10px; font-weight: 600;">اضغط لاختيار صورة أو اسحب الصورة هنا</p>
                                <p style="color: #6c757d; font-size: 14px;">يدعم: JPG, PNG, GIF (الحد الأقصى 5MB)</p>
                                <input type="file" id="heroBackgroundImage" name="backgroundImage" accept="image/*" style="display: none;">
                            </div>
                            <div id="heroImagePreview"></div>
                        </div>
                        
                        <button type="submit" class="btn btn-success" style="width: 100%; margin-top: 20px;">
                            <i class="fas fa-save"></i> حفظ التغييرات
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Activity Logs Section -->
            <div id="activityLogs" class="content-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="color: #2c3e50;">
                        <i class="fas fa-history"></i> سجل الأنشطة
                    </h2>
                    <button onclick="loadActivityLogs()" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i> تحديث
                    </button>
                </div>
                
                <div class="activity-panel">
                    <div id="activityAlert"></div>
                    
                    <div id="activityContainer">
                        <div class="loading show">
                            <div class="spinner"></div>
                            <p>جاري تحميل سجل الأنشطة...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Notifications Section -->
            <div id="notifications" class="content-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="color: #2c3e50;">
                        <i class="fas fa-bell"></i> الإشعارات
                    </h2>
                    <div>
                        <button onclick="loadNotifications()" class="btn btn-primary">
                            <i class="fas fa-sync-alt"></i> تحديث
                        </button>
                        <button onclick="markAllNotificationsAsRead()" class="btn btn-secondary">
                            <i class="fas fa-check-double"></i> تعريف الكل كمقروء
                        </button>
                    </div>
                </div>
                
                <div class="notification-center">
                    <div id="notificationAlert"></div>
                    
                    <div id="notificationContainer">
                        <div class="loading show">
                            <div class="spinner"></div>
                            <p>جاري تحميل الإشعارات...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:4001';
        let authToken = localStorage.getItem('admin_token');
        let refreshToken = localStorage.getItem('admin_refresh_token');
        let currentUser = null;
        let currentOrdersFilter = 'all';
        let currentRevenuePeriod = 'daily';
        let notificationUpdateInterval = null;
        
        // API Client Class with Token Refresh
        class ApiClient {
            constructor(baseURL = API_BASE_URL) {
                this.baseURL = baseURL;
                this.token = localStorage.getItem('admin_token');
                this.refreshToken = localStorage.getItem('admin_refresh_token');
                this.isRefreshing = false;
                this.refreshSubscribers = [];
            }
            
            setToken(token) {
                this.token = token;
                localStorage.setItem('admin_token', token);
            }
            
            setRefreshToken(refreshToken) {
                this.refreshToken = refreshToken;
                localStorage.setItem('admin_refresh_token', refreshToken);
            }
            
            clearTokens() {
                this.token = null;
                this.refreshToken = null;
                localStorage.removeItem('admin_token');
                localStorage.removeItem('admin_refresh_token');
            }
            
            // إضافة دالة للاشتراك في تجديد التوكن
            subscribeTokenRefresh(callback) {
                this.refreshSubscribers.push(callback);
            }
            
            // إضافة دالة لإعلام المشتركين بتجديد التوكن
            notifySubscribers(newToken) {
                this.refreshSubscribers.forEach(callback => callback(newToken));
                this.refreshSubscribers = [];
            }
            
            async request(endpoint, options = {}) {
                const url = `${this.baseURL}${endpoint}`;
                
                const isFormData = options.body instanceof FormData;
                const headers = isFormData ? { 
                    'auth-token': this.token, 
                    'Authorization': `Bearer ${this.token}`,
                    'X-CSRF-Token': this.getCsrfToken()
                } : this.getHeaders(options.auth !== false);
                
                const config = {
                    ...options,
                    headers: {
                        ...headers,
                        ...options.headers
                    },
                    credentials: 'include'
                };
                
                try {
                    updateConnectionStatus(true);
                    let response = await fetch(url, config);
                    
                    // إذا كان التوكن منتهي الصلاحية، حاول تجديده
                    if (response.status === 401) {
                        console.log('Token expired, attempting to refresh...');
                        
                        // إذا لم يكن هناك عملية تجديد جارية، ابدأ عملية التجديد
                        if (!this.isRefreshing) {
                            this.isRefreshing = true;
                            try {
                                const refreshSuccess = await this.refreshAccessToken();
                                
                                if (refreshSuccess) {
                                    // أعد المحاولة مع التوكن الجديد
                                    config.headers['auth-token'] = this.token;
                                    config.headers['Authorization'] = `Bearer ${this.token}`;
                                    config.headers['X-CSRF-Token'] = this.getCsrfToken();
                                    response = await fetch(url, config);
                                    
                                    // أبلغ جميع المشتركين بتجديد التوكن
                                    this.notifySubscribers(this.token);
                                } else {
                                    // فشل تجديد التوكن، أخرج المستخدم
                                    this.clearTokens();
                                    logout();
                                    throw new Error('Session expired. Please login again.');
                                }
                            } finally {
                                this.isRefreshing = false;
                            }
                        } else {
                            // إذا كانت هناك عملية تجديدة جارية، انتظرها
                            return new Promise((resolve, reject) => {
                                this.subscribeTokenRefresh((newToken) => {
                                    config.headers['auth-token'] = newToken;
                                    config.headers['Authorization'] = `Bearer ${newToken}`;
                                    config.headers['X-CSRF-Token'] = this.getCsrfToken();
                                    fetch(url, config)
                                        .then(resolve)
                                        .catch(reject);
                                });
                            });
                        }
                    }
                    
                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.error || `HTTP ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    updateConnectionStatus(false);
                    console.error(`API Error (${endpoint}):`, error);
                    throw error;
                }
            }
            
            async refreshAccessToken() {
                if (!this.refreshToken) {
                    return false;
                }
                
                try {
                    const response = await fetch(`${this.baseURL}/refresh-token`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ refreshToken: this.refreshToken }),
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.setToken(data.token);
                        return true;
                    }
                    
                    return false;
                } catch (error) {
                    console.error('Token refresh error:', error);
                    return false;
                }
            }
            
            getHeaders(includeAuth = true) {
                const headers = {
                    'Content-Type': 'application/json',
                };
                
                if (includeAuth && this.token) {
                    headers['auth-token'] = this.token;
                    headers['Authorization'] = `Bearer ${this.token}`;
                    headers['X-CSRF-Token'] = this.getCsrfToken();
                }
                
                return headers;
            }
            
            getCsrfToken() {
                // محاولة الحصول على رمز CSRF من مكان تخزينه
                return localStorage.getItem('csrf_token') || '';
            }
            
            // Auth methods
            async login(email, password, captcha) {
                return this.request('/admin/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password, captcha }),
                    auth: false
                });
            }
            
            async verifyToken() {
                return this.request('/admin/metrics');
            }
            
            // Admin methods
            async getMetrics() {
                return this.request('/admin/metrics');
            }
            
            async getUsers() {
                return this.request('/admin/users');
            }
            
            async addStaff(staffData) {
                return this.request('/admin/users', {
                    method: 'POST',
                    body: JSON.stringify(staffData)
                });
            }
            
            async updateUserStatus(userId, isActive) {
                return this.request(`/admin/users/${userId}/status`, {
                    method: 'PATCH',
                    body: JSON.stringify({ isActive })
                });
            }
            
            async getOrders(status = 'all', page = 1) {
                const params = new URLSearchParams({ page, limit: 20 });
                if (status !== 'all') params.append('status', status);
                return this.request(`/admin/orders?${params}`);
            }
            
            async updateOrderStatus(orderId, status, notes = '', trackingNumber = '') {
                return this.request(`/admin/orders/${orderId}/status`, {
                    method: 'POST',
                    body: JSON.stringify({ status, notes, trackingNumber })
                });
            }
            
            async deleteOrder(orderId) {
                return this.request(`/admin/orders/${orderId}`, {
                    method: 'DELETE'
                });
            }
            
            async getRevenue(period = 'daily', year = null, month = null) {
                const params = new URLSearchParams({ period });
                if (year) params.append('year', year);
                if (month) params.append('month', month);
                return this.request(`/admin/revenue?${params}`);
            }
            
            async getProducts() {
                return this.request('/allproducts');
            }
            
            async addProduct(productData) {
                return this.request('/addproduct', {
                    method: 'POST',
                    body: JSON.stringify(productData)
                });
            }
            
            async deleteProduct(productId) {
                return this.request('/removeproduct', {
                    method: 'POST',
                    body: JSON.stringify({ _id: productId })
                });
            }
            
            async updateProduct(productData) {
                return this.request('/updateproduct', {
                    method: 'PUT',
                    body: JSON.stringify(productData)
                });
            }
            
            async uploadImage(file) {
                const formData = new FormData();
                formData.append('product', file);
                
                return this.request('/upload', {
                    method: 'POST',
                    body: formData
                });
            }
            
            async getHeroSection() {
                return this.request('/admin/hero');
            }
            
            async updateHeroSection(heroData) {
                return this.request('/admin/hero', {
                    method: 'PUT',
                    body: JSON.stringify(heroData)
                });
            }
            
            // Checkout methods
            async getCartData() {
                return this.request('/getcartdata');
            }
            
            async getCartDetails() {
                return this.request('/cartdetails');
            }
            
            async checkout(paymentMethod, address, phone, captcha) {
                return this.request('/checkout', {
                    method: 'POST',
                    body: JSON.stringify({ paymentMethod, address, phone, captcha })
                });
            }
            
            // Activity Logs methods
            async getActivityLogs(page = 1, limit = 20, action = '') {
                const params = new URLSearchParams({ page, limit });
                if (action) params.append('action', action);
                return this.request(`/api/activity-logs?${params}`);
            }
            
            // Notifications methods
            async getNotifications(page = 1, limit = 20, type = '', unreadOnly = false) {
                const params = new URLSearchParams({ page, limit });
                if (type) params.append('type', type);
                if (unreadOnly) params.append('unreadOnly', 'true');
                return this.request(`/api/notifications?${params}`);
            }
            
            async markNotificationAsRead(notificationId) {
                return this.request(`/api/notifications/${notificationId}/read`, {
                    method: 'PATCH'
                });
            }
            
            async markAllNotificationsAsRead() {
                return this.request('/api/notifications/read-all', {
                    method: 'PATCH'
                });
            }
            
            // Payment methods
            async processStripePayment(amount, paymentMethodId) {
                return this.request('/api/payment/stripe', {
                    method: 'POST',
                    body: JSON.stringify({ amount, paymentMethodId })
                });
            }
            
            async processPayPalPayment(amount) {
                return this.request('/api/payment/paypal', {
                    method: 'POST',
                    body: JSON.stringify({ amount })
                });
            }
            
            // Add to cart method
            async addToCart(productId, quantity = 1, size = 'default') {
                try {
                    const response = await this.request('/addtocart', {
                        method: 'POST',
                        body: JSON.stringify({ 
                            itemId: productId, 
                            quantity, 
                            size,
                            paymentMethod: 'cash_on_delivery'
                        })
                    });
                    
                    if (response.success) {
                        // تحديث واجهة المستخدم
                        showAlert('productsContainer', 'تمت إضافة المنتج إلى السلة', 'success');
                        loadCartData();
                    } else {
                        throw new Error(response.error || 'فشل في إضافة المنتج إلى السلة');
                    }
                } catch (error) {
                    console.error('Add to cart error:', error);
                    
                    // إذا كان الخطأ بسبب انتهاء صلاحية الجلسة، أعد توجيه المستخدم لصفحة تسجيل الدخول
                    if (error.message.includes('Session expired') || error.message.includes('Token expired')) {
                        showAlert('productsContainer', 'انتهت صلاحية الجلسة، يرجى تسجيل الدخول مرة أخرى', 'warning');
                        setTimeout(() => {
                            logout();
                        }, 2000);
                    } else {
                        showAlert('productsContainer', `خطأ في إضافة المنتج: ${error.message}`, 'danger');
                    }
                }
            }
            
            // Get CSRF token
            async getCsrfTokenFromServer() {
                try {
                    const response = await fetch(`${this.baseURL}/csrf-token`, {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.csrfToken) {
                            localStorage.setItem('csrf_token', data.csrfToken);
                            return data.csrfToken;
                        }
                    }
                    
                    return '';
                } catch (error) {
                    console.error('Error getting CSRF token:', error);
                    return '';
                }
            }
        }
        
        const api = new ApiClient();
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            // تحميل رمز CSRF عند بدء التطبيق
            api.getCsrfTokenFromServer();
        });
        
        function initializeApp() {
            if (authToken) {
                verifyToken();
            } else {
                showLogin();
                // تحميل صورة CAPTCHA عند عرض صفحة تسجيل الدخول
                loadCaptcha();
            }
        }
        
        function setupEventListeners() {
            // ربط فورم تسجيل الدخول بالدالة
            document.getElementById("loginForm").addEventListener("submit", handleLogin);
            document.getElementById('addProductForm').addEventListener("submit", handleAddProduct);
            document.getElementById('addStaffForm').addEventListener("submit", handleAddStaff);
            document.getElementById('heroForm').addEventListener("submit", handleHeroUpdate);
            document.getElementById('checkoutForm').addEventListener("submit", handleCheckout);
            
            // Product image upload
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('productImage');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
            
            // Hero image upload
            const heroUploadArea = document.getElementById('heroUploadArea');
            const heroFileInput = document.getElementById('heroBackgroundImage');
            
            heroUploadArea.addEventListener('click', () => heroFileInput.click());
            heroUploadArea.addEventListener('dragover', handleHeroDragOver);
            heroUploadArea.addEventListener('drop', handleHeroDrop);
            heroFileInput.addEventListener('change', handleHeroFileSelect);
            
            setInterval(checkConnection, 30000);
        }
        
        // Connection status management
        function updateConnectionStatus(isConnected) {
            const statusEl = document.getElementById('connectionStatus');
            if (isConnected) {
                statusEl.className = 'connection-status connected';
                statusEl.innerHTML = '<i class="fas fa-wifi"></i> متصل';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.innerHTML = '<i class="fas fa-wifi"></i> منقطع';
            }
        }
        
        async function checkConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/`, { 
                    method: 'GET',
                    timeout: 5000 
                });
                updateConnectionStatus(response.ok);
            } catch (error) {
                updateConnectionStatus(false);
            }
        }
        
        // CAPTCHA functions
        function loadCaptcha() {
            const captchaImage = document.getElementById('captchaImage');
            if (captchaImage) {
                captchaImage.src = `${API_BASE_URL}/captcha?${new Date().getTime()}`;
            }
        }
        
        function refreshCaptcha() {
            loadCaptcha();
            // مسح حقل CAPTCHA
            const captchaInput = document.getElementById('captcha');
            if (captchaInput) {
                captchaInput.value = '';
            }
        }
        
        function loadCheckoutCaptcha() {
            const captchaImage = document.getElementById('checkoutCaptchaImage');
            if (captchaImage) {
                captchaImage.src = `${API_BASE_URL}/captcha?${new Date().getTime()}`;
            }
        }
        
        function refreshCheckoutCaptcha() {
            loadCheckoutCaptcha();
            // مسح حقل CAPTCHA
            const captchaInput = document.getElementById('checkoutCaptcha');
            if (captchaInput) {
                captchaInput.value = '';
            }
        }
        
        // Auth functions
        async function handleLogin(e) {
            // منع إعادة تحميل الصفحة
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const captcha = document.getElementById('captcha').value.trim();
            
            if (!email || !password || !captcha) {
                showAlert('loginAlert', 'يرجى ملء جميع الحقول', 'danger');
                return;
            }
            
            try {
                showAlert('loginAlert', 'جاري تسجيل الدخول...', 'info');
                
                const response = await api.login(email, password, captcha);
         // في دالة handleLogin بعد استلام الاستجابة الناجحة
if (response.success && response.user && response.user.role === 'admin') {
    authToken = response.token;
    refreshToken = response.refreshToken; // تأكد من تخزين refresh token
    currentUser = response.user;
    
    api.setToken(authToken);
    api.setRefreshToken(refreshToken);
    localStorage.setItem('admin_user', JSON.stringify(currentUser));
    localStorage.setItem('admin_role', currentUser.role);
    
    // Clear URL parameters
    window.history.pushState({}, document.title, window.location.pathname);
    
    showDashboard();
    loadDashboardData();
} else {
                    throw new Error('خطأ: يجب أن تكون مدير للوصول لهذه الصفحة');
                }
            } catch (error) {
                console.error('Login error:', error);
                showAlert('loginAlert', error.message || 'خطأ في تسجيل الدخول', 'danger');
                // تحديث صورة CAPTCHA بعد فشل تسجيل الدخول
                refreshCaptcha();
            }
        }
        
        async function verifyToken() {
            try {
                const response = await api.verifyToken();
                
                if (response.success || response.metrics) {
                    const userData = localStorage.getItem('admin_user');
                    if (userData) {
                        currentUser = JSON.parse(userData);
                    }
                    showDashboard();
                    loadDashboardData();
                } else {
                    logout();
                }
            } catch (error) {
                console.error('Token verification failed:', error);
                logout();
            }
        }
        
        function logout() {
            try {
                // إرسال طلب تسجيل الخروج إلى الخادم
                if (refreshToken) {
                    fetch(`${API_BASE_URL}/logout`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'auth-token': authToken
                        },
                        body: JSON.stringify({ refreshToken }),
                        credentials: 'include'
                    });
                }
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                // مسح جميع البيانات المحلية
                authToken = null;
                refreshToken = null;
                currentUser = null;
                localStorage.removeItem('admin_token');
                localStorage.removeItem('admin_refresh_token');
                localStorage.removeItem('admin_user');
                localStorage.removeItem('admin_role');
                localStorage.removeItem('auth-token');
                localStorage.removeItem('refresh-token');
                localStorage.removeItem('user');
                localStorage.removeItem('csrf_token');
                api.clearTokens();
                
                // إيقاف تحديث الإشعارات
                if (notificationUpdateInterval) {
                    clearInterval(notificationUpdateInterval);
                    notificationUpdateInterval = null;
                }
                
                showLogin();
                // تحميل صورة CAPTCHA عند العودة لصفحة تسجيل الدخول
                loadCaptcha();
            }
        }
        
        // UI functions
        function showLogin() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
        }
        
        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            
            if (currentUser && currentUser.fullName) {
                document.getElementById('adminName').textContent = currentUser.fullName;
            }
        }
        
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
            
            // إيقاف تحديث الإشعارات عند مغادرة قسم الإشعارات
            if (sectionId !== 'notifications' && notificationUpdateInterval) {
                clearInterval(notificationUpdateInterval);
                notificationUpdateInterval = null;
            }
            
            if (sectionId === 'dashboard') {
                loadDashboardData();
            } else if (sectionId === 'orders') {
                loadOrders();
            } else if (sectionId === 'checkout') {
                loadCartData();
                // تحميل صورة CAPTCHA عند فتح صفحة الدفع
                loadCheckoutCaptcha();
            } else if (sectionId === 'products') {
                loadProducts();
            } else if (sectionId === 'users') {
                loadUsers();
            } else if (sectionId === 'revenue') {
                loadRevenue(currentRevenuePeriod);
            } else if (sectionId === 'heroSection') {
                loadHeroSection();
            } else if (sectionId === 'activityLogs') {
                loadActivityLogs();
            } else if (sectionId === 'notifications') {
                loadNotifications();
                // بدء تحديث الإشعارات كل 30 ثانية
                startNotificationUpdates();
            }
        }
        
        function showAlert(containerId, message, type, duration = 5000) {
            const container = document.getElementById(containerId);
            const iconMap = {
                success: 'check-circle',
                danger: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            container.innerHTML = `
                <div class="alert alert-${type}">
                    <i class="fas fa-${iconMap[type] || 'info-circle'}"></i>
                    ${message}
                </div>
            `;
            
            if (duration > 0) {
                setTimeout(() => {
                    container.innerHTML = '';
                }, duration);
            }
        }
        
        function showLoading(containerId, message = 'جاري التحميل...') {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="loading show">
                    <div class="spinner"></div>
                    <p>${message}</p>
                </div>
            `;
        }
        
        // Dashboard functions
        async function loadDashboardData() {
            const containerId = 'metricsContainer';
            showLoading(containerId, 'جاري تحميل الإحصائيات...');
            
            try {
                const response = await api.getMetrics();
                
                if (response.success) {
                    displayMetrics(response.metrics);
                } else {
                    throw new Error(response.error || 'فشل في تحميل الإحصائيات');
                }
            } catch (error) {
                console.error('Dashboard metrics error:', error);
                const container = document.getElementById(containerId);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        خطأ في تحميل الإحصائيات: ${error.message}
                        <button onclick="loadDashboardData()" class="btn btn-primary" style="margin-right: 15px;">
                            <i class="fas fa-sync-alt"></i> إعادة المحاولة
                        </button>
                    </div>
                `;
            }
        }
        
        function displayMetrics(metrics) {
            const container = document.getElementById('metricsContainer');
            container.innerHTML = `
                <div class="metric-card" onclick="showSection('products')">
                    <i class="fas fa-box" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.9;"></i>
                    <h3>${metrics.productsCount || 0}</h3>
                    <p>إجمالي المنتجات</p>
                </div>
                
                <div class="metric-card" onclick="showSection('users')">
                    <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.9;"></i>
                    <h3>${metrics.usersCount || 0}</h3>
                    <p>إجمالي المستخدمين</p>
                </div>
                
                <div class="metric-card revenue-card" onclick="showSection('revenue')">
                    <i class="fas fa-dollar-sign" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.9;"></i>
                    <h3>${formatCurrency(metrics.deliveredRevenue || 0)}</h3>
                    <p>إجمالي الإيرادات (مدفوعة)</p>
                    <small style="opacity: 0.8;">من الطلبات التي تم تسليمها فقط</small>
                </div>
                
                <div class="metric-card" onclick="showSection('orders')">
                    <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.9;"></i>
                    <h3>${metrics.deliveredOrdersCount || 0}</h3>
                    <p>عدد الطلبات المُسلمة</p>
                </div>
            `;
        }
        
        // Orders Management
        async function loadOrders(status = currentOrdersFilter) {
            const containerId = 'ordersContainer';
            showLoading(containerId, 'جاري تحميل الطلبات...');
            
            try {
                const response = await api.getOrders(status);
                
                if (response.success) {
                    displayOrders(response.orders);
                } else {
                    throw new Error(response.error || 'فشل في تحميل الطلبات');
                }
            } catch (error) {
                console.error('Load orders error:', error);
                const container = document.getElementById(containerId);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        خطأ في تحميل الطلبات: ${error.message}
                        <button onclick="loadOrders()" class="btn btn-primary" style="margin-right: 15px;">
                            <i class="fas fa-sync-alt"></i> إعادة المحاولة
                        </button>
                    </div>
                `;
            }
        }
        
        function displayOrders(orders) {
            const container = document.getElementById('ordersContainer');
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        لا توجد طلبات في هذه الفئة حالياً
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="orders-grid">
                    ${orders.map(order => `
                        <div class="order-card ${order.status}">
                            <div class="order-header">
                                <div class="order-id">#${order.orderId}</div>
                                <div class="order-status status-${order.status}">
                                    ${getStatusName(order.status)}
                                </div>
                            </div>
                            
                            <div class="customer-info">
                                <h4><i class="fas fa-user"></i> معلومات العميل</h4>
                                <div class="customer-details">
                                    <div><i class="fas fa-id-card"></i> <strong>الاسم:</strong> ${order.customerInfo.fullName}</div>
                                    <div><i class="fas fa-envelope"></i> <strong>البريد:</strong> ${order.customerInfo.email}</div>
                                    <div><i class="fas fa-phone"></i> <strong>الهاتف:</strong> ${order.customerInfo.phone}</div>
                                    <div><i class="fas fa-map-marker-alt"></i> <strong>المحافظة:</strong> ${order.customerInfo.governorate}</div>
                                    <div style="grid-column: 1 / -1;"><i class="fas fa-home"></i> <strong>العنوان:</strong> ${order.customerInfo.address}</div>
                                </div>
                            </div>
                            
                            <div class="order-items">
                                <h4><i class="fas fa-shopping-bag"></i> المنتجات (${order.items.length})</h4>
                                ${order.items.map(item => `
                                    <div class="order-item">
                                        <img src="${item.productImage || '/images/default.jpg'}" 
                                             alt="${item.productName}" 
                                             onerror="this.src='/images/default.jpg'">
                                        <div class="item-details">
                                            <div class="item-name">${item.productName}</div>
                                            <div class="item-info">
                                                المقاس: ${item.size || 'غير محدد'} | 
                                                الكمية: ${item.quantity} | 
                                                السعر: ${formatCurrency(item.price)}
                                            </div>
                                            <div class="item-status status-${item.status}">
                                                ${item.status === 'checkedout' ? 'مدفوع' : 'في السلة'}
                                            </div>
                                        </div>
                                        <div style="font-weight: bold; color: #28a745;">
                                            ${formatCurrency(item.itemTotal)}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="order-total">
                                <i class="fas fa-calculator"></i> إجمالي الطلب: ${formatCurrency(order.total)}
                            </div>
                            
                            <div class="order-actions">
                                ${order.status === 'pending' ? `
                                    <button onclick="updateOrderStatus('${order.id}', 'processing')" class="btn btn-info">
                                        <i class="fas fa-cogs"></i> بدء المعالجة
                                    </button>
                                ` : ''}
                                ${order.status === 'processing' ? `
                                    <button onclick="updateOrderStatus('${order.id}', 'shipped')" class="btn btn-warning">
                                        <i class="fas fa-truck"></i> شحن الطلب
                                    </button>
                                ` : ''}
                                ${order.status === 'shipped' ? `
                                    <button onclick="updateOrderStatus('${order.id}', 'delivered')" class="btn btn-success">
                                        <i class="fas fa-check"></i> تم التسليم
                                    </button>
                                ` : ''}
                                ${order.status !== 'cancelled' && order.status !== 'delivered' ? `
                                    <button onclick="updateOrderStatus('${order.id}', 'cancelled')" class="btn btn-danger">
                                        <i class="fas fa-times"></i> إلغاء الطلب
                                    </button>
                                ` : ''}
                                <button onclick="deleteOrder('${order.id}', '${order.orderId}')" class="btn btn-secondary">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                            </div>
                            
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; font-size: 0.9rem; color: #6c757d;">
                                <i class="fas fa-calendar"></i> تاريخ الطلب: ${formatDate(order.orderDate)}
                                ${order.deliveredAt ? `<br><i class="fas fa-check-circle"></i> تم التسليم: ${formatDate(order.deliveredAt)}` : ''}
                                ${order.cancelledAt ? `<br><i class="fas fa-times-circle"></i> تم الإلغاء: ${formatDate(order.cancelledAt)}` : ''}
                                ${order.trackingNumber ? `<br><i class="fas fa-truck"></i> رقم التتبع: ${order.trackingNumber}` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function filterOrders(status, buttonElement) {
            currentOrdersFilter = status;
            
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            buttonElement.classList.add('active');
            
            // Load orders with new filter
            loadOrders(status);
        }
        
        async function updateOrderStatus(orderId, newStatus) {
            try {
                let notes = '';
                let trackingNumber = '';
                
                if (newStatus === 'cancelled') {
                    notes = prompt('سبب الإلغاء (اختياري):') || 'تم الإلغاء من قبل الإدمن';
                } else if (newStatus === 'shipped') {
                    trackingNumber = prompt('رقم التتبع (اختياري):') || '';
                }
                
                const response = await api.updateOrderStatus(orderId, newStatus, notes, trackingNumber);
                
                if (response.success) {
                    showAlert('ordersContainer', `تم تحديث حالة الطلب إلى ${getStatusName(newStatus)}`, 'success');
                    loadOrders(currentOrdersFilter);
                    loadDashboardData(); // Refresh metrics
                } else {
                    throw new Error(response.error || 'فشل في تحديث حالة الطلب');
                }
            } catch (error) {
                console.error('Update order status error:', error);
                showAlert('ordersContainer', `خطأ في تحديث الطلب: ${error.message}`, 'danger');
            }
        }
        
        async function deleteOrder(orderId, orderNumber) {
            if (!confirm(`هل أنت متأكد من حذف الطلب #${orderNumber}؟\nلا يمكن التراجع عن هذا الإجراء.`)) {
                return;
            }
            
            try {
                const response = await api.deleteOrder(orderId);
                
                if (response.success) {
                    showAlert('ordersContainer', `تم حذف الطلب #${orderNumber} بنجاح`, 'success');
                    loadOrders(currentOrdersFilter);
                    loadDashboardData(); // Refresh metrics
                } else {
                    throw new Error(response.error || 'فشل في حذف الطلب');
                }
            } catch (error) {
                console.error('Delete order error:', error);
                showAlert('ordersContainer', `خطأ في حذف الطلب: ${error.message}`, 'danger');
            }
        }
        
        function getStatusName(status) {
            const statusNames = {
                pending: 'قيد الانتظار',
                processing: 'قيد المعالجة',
                shipped: 'تم الشحن',
                delivered: 'تم التسليم',
                cancelled: 'ملغي'
            };
            return statusNames[status] || status;
        }
        
        // Checkout functions
        async function loadCartData() {
            const containerId = 'cartSummary';
            showLoading(containerId, 'جاري تحميل بيانات السلة...');
            
            try {
                const response = await api.getCartDetails();
                
                if (response.success) {
                    displayCartData(response.cartDetails, response.summary);
                } else {
                    throw new Error(response.error || 'فشل في تحميل بيانات السلة');
                }
            } catch (error) {
                console.error('Load cart data error:', error);
                const container = document.getElementById(containerId);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        خطأ في تحميل بيانات السلة: ${error.message}
                        <button onclick="loadCartData()" class="btn btn-primary" style="margin-right: 15px;">
                            <i class="fas fa-sync-alt"></i> إعادة المحاولة
                        </button>
                    </div>
                `;
            }
        }
        
        function displayCartData(cartDetails, summary) {
            const container = document.getElementById('cartSummary');
            
            if (cartDetails.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        السلة فارغة حالياً
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <h3 style="margin-bottom: 20px; color: #2c3e50;">
                    <i class="fas fa-shopping-cart"></i> ملخص السلة
                </h3>
                
                <div style="margin-bottom: 20px;">
                    ${cartDetails.map(item => `
                        <div class="cart-item">
                            <img src="${item.product.image || '/images/default.jpg'}" 
                                 alt="${item.product.name}" 
                                 onerror="this.src='/images/default.jpg'">
                            <div class="item-details">
                                <div class="item-name">${item.product.name}</div>
                                <div class="item-info">
                                    المقاس: ${item.size || 'غير محدد'} | 
                                    الكمية: ${item.quantity} | 
                                    السعر: ${formatCurrency(item.product.new_price)}
                                </div>
                                <div class="item-status status-in-cart">
                                    في السلة
                                </div>
                            </div>
                            <div style="font-weight: bold; color: #28a745;">
                                ${formatCurrency(item.itemTotal)}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 1.1rem; margin-bottom: 10px;">
                        <strong>إجمالي العناصر:</strong> ${summary.totalItems}
                    </div>
                    <div style="font-size: 1.3rem; font-weight: bold; color: #28a745;">
                        <strong>الإجمالي:</strong> ${formatCurrency(summary.totalAmount)}
                    </div>
                </div>
            `;
        }
        
        async function handleCheckout(e) {
            e.preventDefault();
            
            const paymentMethod = document.getElementById('paymentMethod').value;
            const phone = document.getElementById('checkoutPhone').value.trim();
            const address = document.getElementById('checkoutAddress').value.trim();
            const governorate = document.getElementById('checkoutGovernorate').value.trim();
            const captcha = document.getElementById('checkoutCaptcha').value.trim();
            
            if (!paymentMethod || !phone || !address || !governorate || !captcha) {
                showAlert('checkoutAlert', 'يرجى ملء جميع الحقول المطلوبة', 'danger');
                return;
            }
            
            try {
                showAlert('checkoutAlert', 'جاري معالجة الدفع...', 'info');
                
                const response = await api.checkout(paymentMethod, { address, governorate }, phone, captcha);
                
                if (response.success) {
                    showAlert('checkoutAlert', 'تمت عملية الدفع بنجاح! تم تغيير حالة العناصر إلى مدفوع', 'success');
                    
                    // Reset form
                    document.getElementById('checkoutForm').reset();
                    
                    // Reload cart data
                    loadCartData();
                    
                    // Refresh dashboard metrics
                    loadDashboardData();
                    
                    // Show success message with order details
                    setTimeout(() => {
                        alert(`تم إنشاء الطلب #${response.order.orderId} بنجاح!\nالإجمالي: ${formatCurrency(response.order.total)}\nطريقة الدفع: ${paymentMethod}`);
                    }, 1000);
                } else {
                    throw new Error(response.error || 'فشل في عملية الدفع');
                }
            } catch (error) {
                console.error('Checkout error:', error);
                showAlert('checkoutAlert', `خطأ في عملية الدفع: ${error.message}`, 'danger');
                // تحديث صورة CAPTCHA بعد فشل عملية الدفع
                refreshCheckoutCaptcha();
            }
        }
        
        // Payment handlers
        function handleStripePayment() {
            alert('سيتم توجيهك إلى صفحة الدفع عبر Stripe قريبًا');
            // Implementation will be added later
        }
        
        function handlePayPalPayment() {
            alert('سيتم توجيهك إلى صفحة الدفع عبر PayPal قريبًا');
            // Implementation will be added later
        }
        
        // Products Management
        async function loadProducts() {
            const containerId = 'productsContainer';
            showLoading(containerId, 'جاري تحميل المنتجات...');
            
            try {
                const products = await api.getProducts();
                displayProducts(products);
            } catch (error) {
                console.error('Load products error:', error);
                const container = document.getElementById(containerId);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        خطأ في تحميل المنتجات: ${error.message}
                        <button onclick="loadProducts()" class="btn btn-primary" style="margin-right: 15px;">
                            <i class="fas fa-sync-alt"></i> إعادة المحاولة
                        </button>
                    </div>
                `;
            }
        }
        
        function displayProducts(products) {
            const container = document.getElementById('productsContainer');
            
            if (products.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        لا توجد منتجات مضافة حالياً
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="products-grid">
                    ${products.map(product => `
                        <div class="product-card">
                            <img src="${product.image || '/images/default.jpg'}" 
                                 alt="${product.name}" 
                                 class="product-image"
                                 onerror="this.src='/images/default.jpg'">
                            
                            <div class="product-info">
                                <h3>${product.name}</h3>
                                <p style="color: #6c757d; font-size: 14px; margin-bottom: 10px;">
                                    <i class="fas fa-tag"></i> ${product.category}
                                </p>
                                <p style="color: #6c757d; font-size: 14px; margin-bottom: 10px;">
                                    ${product.description || 'لا يوجد وصف'}
                                </p>
                                <div class="product-price">
                                    <span class="new-price">${formatCurrency(product.new_price)}</span>
                                    ${product.old_price ? `<span class="old-price">${formatCurrency(product.old_price)}</span>` : ''}
                                </div>
                                <p style="color: #6c757d; font-size: 14px; margin-bottom: 15px;">
                                    <i class="fas fa-ruler"></i> المقاسات: ${(product.sizes || []).join(', ') || 'غير محدد'}
                                </p>
                            </div>
                            
                            <div class="product-actions">
                                <button onclick="editProduct('${product._id}')" class="btn btn-warning">
                                    <i class="fas fa-edit"></i> تعديل
                                </button>
                                <button onclick="deleteProduct('${product._id}', '${product.name}')" class="btn btn-danger">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                                <button onclick="toggleProductStatus('${product._id}', ${product.available})" class="btn btn-${product.available ? 'secondary' : 'success'}">
                                    <i class="fas fa-toggle-${product.available ? 'on' : 'off'}"></i>
                                    ${product.available ? 'إخفاء' : 'إظهار'}
                                </button>
                                <button onclick="api.addToCart('${product.id}', 1, 'M')" class="btn btn-primary">
                                    <i class="fas fa-cart-plus"></i> إضافة للسلة
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        async function deleteProduct(productId, productName) {
            if (!confirm(`هل أنت متأكد من حذف المنتج "${productName}"؟\nلا يمكن التراجع عن هذا الإجراء.`)) {
                return;
            }
            
            try {
                const response = await api.deleteProduct(productId);
                
                if (response.success) {
                    showAlert('productsContainer', `تم حذف المنتج "${productName}" بنجاح`, 'success');
                    loadProducts();
                    loadDashboardData(); // Refresh metrics
                } else {
                    throw new Error(response.error || 'فشل في حذف المنتج');
                }
            } catch (error) {
                console.error('Delete product error:', error);
                showAlert('productsContainer', `خطأ في حذف المنتج: ${error.message}`, 'danger');
            }
        }
        
        function editProduct(productId) {
            // Redirect to add product form with product data
            showSection('addProduct');
            // Load product data into form
            // This is a simplified version - in a real app, you'd fetch the product data
            alert('ميزة تعديل المنتج ستكون متاحة قريبًا');
        }
        
        function toggleProductStatus(productId, currentStatus) {
            alert('ميزة تغيير حالة المنتج ستكون متاحة قريبًا');
        }
        
        // Add Product functionality
        async function handleAddProduct(e) {
            e.preventDefault();
            
            const formData = new FormData();
            const name = document.getElementById('productName').value.trim();
            const title = document.getElementById('productTitle').value.trim();
            const category = document.getElementById('productCategory').value;
            const newPrice = parseFloat(document.getElementById('productNewPrice').value);
            const oldPrice = parseFloat(document.getElementById('productOldPrice').value) || 0;
            const description = document.getElementById('productDescription').value.trim();
            const imageFile = document.getElementById('productImage').files[0];
            
            // Get selected sizes
            const sizeCheckboxes = document.querySelectorAll('#sizesContainer input[type="checkbox"]:checked');
            const sizes = Array.from(sizeCheckboxes).map(cb => cb.value);
            
            if (!name || !category || !newPrice || sizes.length === 0) {
                showAlert('addProductAlert', 'يرجى ملء جميع الحقول المطلوبة', 'danger');
                return;
            }
            
            try {
                showAlert('addProductAlert', 'جاري إضافة المنتج...', 'info');
                
                let imageUrl = '';
                
                // Upload image if provided
                if (imageFile) {
                    const uploadResponse = await api.uploadImage(imageFile);
                    if (uploadResponse.success) {
                        imageUrl = uploadResponse.image_url;
                    } else {
                        throw new Error('فشل في رفع الصورة');
                    }
                }
                
                // Create product data
                const productData = {
                    name,
                    title: title || name,
                    category,
                    new_price: newPrice,
                    old_price: oldPrice,
                    description: description || `وصف ${name}`,
                    sizes,
                    image: imageUrl,
                    available: true
                };
                
                const response = await api.addProduct(productData);
                
                if (response.success) {
                    showAlert('addProductAlert', 'تم إضافة المنتج بنجاح!', 'success');
                    document.getElementById('addProductForm').reset();
                    document.getElementById('imagePreview').innerHTML = '';
                    
                    // Reset size checkboxes to default
                    document.querySelectorAll('#sizesContainer input[type="checkbox"]').forEach(cb => {
                        cb.checked = ['S', 'M', 'L', 'XL', 'XXL'].includes(cb.value);
                    });
                    
                    loadDashboardData(); // Refresh metrics
                } else {
                    throw new Error(response.error || 'فشل في إضافة المنتج');
                }
            } catch (error) {
                console.error('Add product error:', error);
                showAlert('addProductAlert', `خطأ في إضافة المنتج: ${error.message}`, 'danger');
            }
        }
        
        // File upload handlers
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('uploadArea').classList.add('dragover');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('productImage').files = files;
                handleFileSelect({ target: { files } });
            }
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showAlert('addProductAlert', 'يرجى اختيار ملف صورة صالح', 'danger');
                return;
            }
            
            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                showAlert('addProductAlert', 'حجم الصورة يجب أن يكون أقل من 5 ميجابايت', 'danger');
                return;
            }
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').innerHTML = `
                    <img src="${e.target.result}" class="image-preview" alt="معاينة الصورة">
                `;
            };
            reader.readAsDataURL(file);
        }
        
        // Enhanced Users Management
        async function loadUsers() {
            const containerId = 'usersContainer';
            showLoading(containerId, 'جاري تحميل المستخدمين...');
            
            try {
                const response = await api.getUsers();
                
                if (response.success) {
                    displayUsers(response.users);
                } else {
                    throw new Error(response.error || 'فشل في تحميل المستخدمين');
                }
            } catch (error) {
                console.error('Load users error:', error);
                const container = document.getElementById(containerId);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        خطأ في تحميل المستخدمين: ${error.message}
                        <button onclick="loadUsers()" class="btn btn-primary" style="margin-right: 15px;">
                            <i class="fas fa-sync-alt"></i> إعادة المحاولة
                        </button>
                    </div>
                `;
            }
        }
        
        function displayUsers(users) {
            const container = document.getElementById('usersContainer');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        لا توجد مستخدمين مسجلين حالياً
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="users-grid">
                    ${users.map(user => `
                        <div class="user-card">
                            <div class="user-header">
                                <div class="user-name">${user.fullName}</div>
                                <div class="user-role role-${user.role}">
                                    ${getRoleName(user.role)}
                                </div>
                            </div>
                            
                            <div class="user-details">
                                <div class="user-detail">
                                    <i class="fas fa-envelope"></i>
                                    <span>${user.email}</span>
                                </div>
                                <div class="user-detail">
                                    <i class="fas fa-phone"></i>
                                    <span>${user.phone}</span>
                                </div>
                                <div class="user-detail">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${user.governorate}</span>
                                </div>
                                <div class="user-detail" style="grid-column: 1 / -1;">
                                    <i class="fas fa-home"></i>
                                    <span>${user.address}</span>
                                </div>
                                <div class="user-detail">
                                    <i class="fas fa-calendar"></i>
                                    <span>${formatDate(user.joinDate)}</span>
                                </div>
                                <div class="user-detail">
                                    <i class="fas fa-sign-in-alt"></i>
                                    <span>${formatDate(user.lastLogin)}</span>
                                </div>
                                <div class="user-detail">
                                    <i class="fas fa-toggle-${user.isActive ? 'on' : 'off'}"></i>
                                    <span style="color: ${user.isActive ? '#28a745' : '#dc3545'}">
                                        ${user.isActive ? 'نشط' : 'غير نشط'}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="product-actions" style="margin-top: 15px;">
                                <button onclick="toggleUserStatus('${user.id}', ${user.isActive})" class="btn btn-${user.isActive ? 'secondary' : 'success'}">
                                    <i class="fas fa-toggle-${user.isActive ? 'off' : 'on'}"></i>
                                    ${user.isActive ? 'تعطيل' : 'تفعيل'}
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function getRoleName(role) {
            const roleNames = {
                admin: 'مدير',
                manager: 'مدير قسم',
                support: 'دعم فني',
                user: 'مستخدم'
            };
            return roleNames[role] || role;
        }
        
        async function toggleUserStatus(userId, currentStatus) {
            try {
                const response = await api.updateUserStatus(userId, !currentStatus);
                
                if (response.success) {
                    showAlert('usersContainer', `تم ${!currentStatus ? 'تفعيل' : 'تعطيل'} المستخدم بنجاح`, 'success');
                    loadUsers();
                } else {
                    throw new Error(response.error || 'فشل في تحديث حالة المستخدم');
                }
            } catch (error) {
                console.error('Toggle user status error:', error);
                showAlert('usersContainer', `خطأ في تحديث حالة المستخدم: ${error.message}`, 'danger');
            }
        }
        
        // Add Staff functionality
        async function handleAddStaff(e) {
            e.preventDefault();
            
            const fullName = document.getElementById('staffFullName').value.trim();
            const email = document.getElementById('staffEmail').value.trim();
            const password = document.getElementById('staffPassword').value;
            const role = document.getElementById('staffRole').value;
            const phone = document.getElementById('staffPhone').value.trim();
            const address = document.getElementById('staffAddress').value.trim();
            const governorate = document.getElementById('staffGovernorate').value.trim();
            
            if (!fullName || !email || !password || !role) {
                showAlert('addStaffAlert', 'يرجى ملء جميع الحقول المطلوبة', 'danger');
                return;
            }
            
            try {
                showAlert('addStaffAlert', 'جاري إضافة الموظف...', 'info');
                
                const staffData = {
                    fullName,
                    email,
                    password,
                    role,
                    phone,
                    address,
                    governorate
                };
                
                const response = await api.addStaff(staffData);
                
                if (response.success) {
                    showAlert('addStaffAlert', 'تم إضافة الموظف بنجاح!', 'success');
                    document.getElementById('addStaffForm').reset();
                    loadUsers();
                } else {
                    throw new Error(response.error || 'فشل في إضافة الموظف');
                }
            } catch (error) {
                console.error('Add staff error:', error);
                showAlert('addStaffAlert', `خطأ في إضافة الموظف: ${error.message}`, 'danger');
            }
        }
        
        // Revenue Analytics - REAL DATA FROM DELIVERED ORDERS
        async function loadRevenue(period = 'daily', buttonElement = null) {
            const containerId = 'revenueContainer';
            showLoading(containerId, 'جاري تحميل تحليل الإيرادات...');
            
            currentRevenuePeriod = period;
            
            // Update active button
            if (buttonElement) {
                document.querySelectorAll('.revenue-filters .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                buttonElement.classList.add('active');
            }
            
            try {
                const response = await api.getRevenue(period);
                
                if (response.success) {
                    displayRevenueAnalytics(response.data, period);
                } else {
                    throw new Error(response.error || 'فشل في تحميل تحليل الإيرادات');
                }
            } catch (error) {
                console.error('Load revenue error:', error);
                const container = document.getElementById(containerId);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        خطأ في تحميل تحليل الإيرادات: ${error.message}
                        <button onclick="loadRevenue('${period}')" class="btn btn-primary" style="margin-right: 15px;">
                            <i class="fas fa-sync-alt"></i> إعادة المحاولة
                        </button>
                    </div>
                `;
            }
        }
        
        function displayRevenueAnalytics(data, period) {
            const container = document.getElementById('revenueContainer');
            
            if (data.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        لا توجد بيانات إيرادات متاحة لهذه الفترة
                    </div>
                `;
                return;
            }
            
            // Calculate total revenue based on period
            const totalRevenue = data.reduce((sum, item) => {
                if (period === 'daily') {
                    return sum + (item.deliveredRevenue || 0);
                } else if (period === 'monthly') {
                    return sum + (item.monthlyRevenue || 0);
                } else if (period === 'yearly') {
                    return sum + (item.yearlyRevenue || 0);
                }
                return sum;
            }, 0);
            
            const totalOrders = data.reduce((sum, item) => sum + (item.ordersCount || 0), 0);
            const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
            
            let chartData = '';
            if (period === 'daily') {
                chartData = data.map(item => `
                    <div class="revenue-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;">
                        <span>${formatDate(item.date)}</span>
                        <span style="font-weight: bold; color: #28a745;">${formatCurrency(item.deliveredRevenue || 0)}</span>
                    </div>
                `).join('');
            } else if (period === 'monthly') {
                chartData = data.map(item => `
                    <div class="revenue-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;">
                        <span>${item._id.year}/${item._id.month}</span>
                        <span style="font-weight: bold; color: #28a745;">${formatCurrency(item.monthlyRevenue || 0)}</span>
                    </div>
                `).join('');
            } else {
                chartData = data.map(item => `
                    <div class="revenue-item" style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;">
                        <span>${item._id.year}</span>
                        <span style="font-weight: bold; color: #28a745;">${formatCurrency(item.yearlyRevenue || 0)}</span>
                    </div>
                `).join('');
            }
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div class="metric-card revenue-card">
                        <i class="fas fa-chart-line" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <h3>${formatCurrency(totalRevenue)}</h3>
                        <p>إجمالي الإيرادات (${getPeriodName(period)})</p>
                        <small style="opacity: 0.8;">من الطلبات التي تم تسليمها فقط</small>
                    </div>
                    <div class="metric-card">
                        <i class="fas fa-shopping-cart" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <h3>${totalOrders}</h3>
                        <p>إجمالي الطلبات</p>
                        <small style="opacity: 0.8;">الطلبات التي تم تسليمها</small>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);">
                        <i class="fas fa-calculator" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <h3>${formatCurrency(avgOrderValue)}</h3>
                        <p>متوسط قيمة الطلب</p>
                        <small style="opacity: 0.8;">متوسط قيمة الطلب المدفوع</small>
                    </div>
                </div>
                
                <div class="revenue-chart">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">
                        <i class="fas fa-chart-bar"></i> تفصيل الإيرادات (${getPeriodName(period)})
                    </h3>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${chartData}
                    </div>
                </div>
            `;
        }
        
        function getPeriodName(period) {
            const names = {
                daily: 'يومي',
                monthly: 'شهري',
                yearly: 'سنوي'
            };
            return names[period] || period;
        }
        
        // Hero Section Management
        async function loadHeroSection() {
            try {
                const response = await api.getHeroSection();
                
                if (response.success) {
                    const heroSection = response.heroSection;
                    
                    // Populate form with current hero section data
                    document.getElementById('heroTitle').value = heroSection.title;
                    document.getElementById('heroSubtitle').value = heroSection.subtitle;
                    document.getElementById('heroButtonText').value = heroSection.buttonText;
                    document.getElementById('heroButtonLink').value = heroSection.buttonLink;
                    
                    // Show current image
                    if (heroSection.backgroundImage) {
                        document.getElementById('heroImagePreview').innerHTML = `
                            <img src="${heroSection.backgroundImage}" class="image-preview" alt="معاينة صورة الخلفية">
                        `;
                    }
                } else {
                    throw new Error(response.error || 'فشل في تحميل قسم البطل');
                }
            } catch (error) {
                console.error('Load hero section error:', error);
                showAlert('heroAlert', `خطأ في تحميل قسم البطل: ${error.message}`, 'danger');
            }
        }
        
        async function handleHeroUpdate(e) {
            e.preventDefault();
            
            const title = document.getElementById('heroTitle').value.trim();
            const subtitle = document.getElementById('heroSubtitle').value.trim();
            const buttonText = document.getElementById('heroButtonText').value.trim();
            const buttonLink = document.getElementById('heroButtonLink').value.trim();
            const imageFile = document.getElementById('heroBackgroundImage').files[0];
            
            if (!title || !subtitle || !buttonText || !buttonLink) {
                showAlert('heroAlert', 'يرجى ملء جميع الحقول المطلوبة', 'danger');
                return;
            }
            
            try {
                showAlert('heroAlert', 'جاري حفظ التغييرات...', 'info');
                
                let backgroundImage = '';
                
                // Upload image if provided
                if (imageFile) {
                    const uploadResponse = await api.uploadImage(imageFile);
                    if (uploadResponse.success) {
                        backgroundImage = uploadResponse.image_url;
                    } else {
                        throw new Error('فشل في رفع الصورة');
                    }
                } else {
                    // Keep existing image if no new image is uploaded
                    const currentImage = document.querySelector('#heroImagePreview img');
                    if (currentImage) {
                        backgroundImage = currentImage.src;
                    }
                }
                
                // Create hero section data
                const heroData = {
                    title,
                    subtitle,
                    buttonText,
                    buttonLink,
                    backgroundImage
                };
                
                const response = await api.updateHeroSection(heroData);
                
                if (response.success) {
                    showAlert('heroAlert', 'تم حفظ التغييرات بنجاح!', 'success');
                } else {
                    throw new Error(response.error || 'فشل في حفظ التغييرات');
                }
            } catch (error) {
                console.error('Update hero section error:', error);
                showAlert('heroAlert', `خطأ في حفظ التغييرات: ${error.message}`, 'danger');
            }
        }
        
        // Hero image upload handlers
        function handleHeroDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('heroUploadArea').classList.add('dragover');
        }
        
        function handleHeroDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            const uploadArea = document.getElementById('heroUploadArea');
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('heroBackgroundImage').files = files;
                handleHeroFileSelect({ target: { files } });
            }
        }
        
        function handleHeroFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showAlert('heroAlert', 'يرجى اختيار ملف صورة صالح', 'danger');
                return;
            }
            
            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                showAlert('heroAlert', 'حجم الصورة يجب أن يكون أقل من 5 ميجابايت', 'danger');
                return;
            }
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('heroImagePreview').innerHTML = `
                    <img src="${e.target.result}" class="image-preview" alt="معاينة صورة الخلفية">
                `;
            };
            reader.readAsDataURL(file);
        }
        
        // Activity Logs functions
        async function loadActivityLogs() {
            const containerId = 'activityContainer';
            showLoading(containerId, 'جاري تحميل سجل الأنشطة...');
            
            try {
                const response = await api.getActivityLogs();
                
                if (response.success) {
                    displayActivityLogs(response.logs);
                } else {
                    throw new Error(response.error || 'فشل في تحميل سجل الأنشطة');
                }
            } catch (error) {
                console.error('Load activity logs error:', error);
                const container = document.getElementById(containerId);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        خطأ في تحميل سجل الأنشطة: ${error.message}
                        <button onclick="loadActivityLogs()" class="btn btn-primary" style="margin-right: 15px;">
                            <i class="fas fa-sync-alt"></i> إعادة المحاولة
                        </button>
                    </div>
                `;
            }
        }
        
        function displayActivityLogs(logs) {
            const container = document.getElementById('activityContainer');
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        لا توجد أنشطة مسجلة حالياً
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <table class="activity-table">
                    <thead>
                        <tr>
                            <th>الإدمن</th>
                            <th>الإجراء</th>
                            <th>التفاصيل</th>
                            <th>التوقيت</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${logs.map(log => `
                            <tr>
                                <td class="activity-admin">${log.adminId?.fullName || 'غير معروف'}</td>
                                <td class="activity-action">${getActionName(log.action)}</td>
                                <td>${getActionDetails(log.details)}</td>
                                <td class="activity-time">${formatDateTime(log.timestamp)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function getActionName(action) {
            const actionNames = {
                admin_login: 'تسجيل دخول',
                view_users: 'عرض المستخدمين',
                add_staff: 'إضافة موظف',
                update_user_status: 'تحديث حالة المستخدم',
                view_orders: 'عرض الطلبات',
                update_order_status: 'تحديث حالة الطلب',
                delete_order: 'حذف طلب',
                view_revenue: 'عرض الإيرادات',
                view_hero: 'عرض قسم البطل',
                update_hero: 'تحديث قسم البطل',
                add_product: 'إضافة منتج',
                remove_product: 'حذف منتج',
                update_product: 'تحديث منتج',
                upload_image: 'رفع صورة',
                upgrade_to_admin: 'ترقية إلى أدمن'
            };
            return actionNames[action] || action;
        }
        
        function getActionDetails(details) {
            if (!details) return '-';
            
            if (details.method && details.url) {
                return `${details.method} ${details.url}`;
            }
            
            return JSON.stringify(details);
        }
        
        // Notifications functions
        async function loadNotifications() {
            const containerId = 'notificationContainer';
            showLoading(containerId, 'جاري تحميل الإشعارات...');
            
            try {
                const response = await api.getNotifications();
                
                if (response.success) {
                    displayNotifications(response.notifications);
                } else {
                    throw new Error(response.error || 'فشل في تحميل الإشعارات');
                }
            } catch (error) {
                console.error('Load notifications error:', error);
                const container = document.getElementById(containerId);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        خطأ في تحميل الإشعارات: ${error.message}
                        <button onclick="loadNotifications()" class="btn btn-primary" style="margin-right: 15px;">
                            <i class="fas fa-sync-alt"></i> إعادة المحاولة
                        </button>
                    </div>
                `;
            }
        }
        
        function displayNotifications(notifications) {
            const container = document.getElementById('notificationContainer');
            
            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        لا توجد إشعارات حالياً
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                ${notifications.map(notification => `
                    <div class="notification-item ${notification.isRead ? '' : 'unread'}">
                        <div class="notification-icon ${notification.type}">
                            <i class="fas fa-${getNotificationIcon(notification.type)}"></i>
                        </div>
                        <div class="notification-content">
                            <div class="notification-message">${notification.message}</div>
                            <div class="notification-time">${formatDateTime(notification.timestamp)}</div>
                        </div>
                        ${!notification.isRead ? `
                            <button class="notification-mark-read" onclick="markNotificationAsRead('${notification._id}')">
                                تعيين كمقروء
                            </button>
                        ` : ''}
                    </div>
                `).join('')}
            `;
        }
        
        function getNotificationIcon(type) {
            const icons = {
                info: 'info-circle',
                success: 'check-circle',
                warning: 'exclamation-triangle',
                error: 'times-circle'
            };
            return icons[type] || 'bell';
        }
        
        async function markNotificationAsRead(notificationId) {
            try {
                const response = await api.markNotificationAsRead(notificationId);
                
                if (response.success) {
                    loadNotifications();
                } else {
                    throw new Error(response.error || 'فشل في تعيين الإشعار كمقروء');
                }
            } catch (error) {
                console.error('Mark notification as read error:', error);
                showAlert('notificationAlert', `خطأ في تعيين الإشعار كمقروء: ${error.message}`, 'danger');
            }
        }
        
        async function markAllNotificationsAsRead() {
            try {
                const response = await api.markAllNotificationsAsRead();
                
                if (response.success) {
                    showAlert('notificationAlert', 'تم تعيين جميع الإشعارات كمقروء', 'success');
                    loadNotifications();
                } else {
                    throw new Error(response.error || 'فشل في تعيين جميع الإشعارات كمقروء');
                }
            } catch (error) {
                console.error('Mark all notifications as read error:', error);
                showAlert('notificationAlert', `خطأ في تعيين جميع الإشعارات كمقروء: ${error.message}`, 'danger');
            }
        }
        
        function startNotificationUpdates() {
            // بدء تحديث الإشعارات كل 30 ثانية
            if (notificationUpdateInterval) {
                clearInterval(notificationUpdateInterval);
            }
            
            notificationUpdateInterval = setInterval(() => {
                loadNotifications();
            }, 30000);
        }
        
        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ar-EG', {
                style: 'currency',
                currency: 'EGP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }).format(amount || 0);
        }
        
        function formatDate(dateString) {
            if (!dateString || dateString === 'لم يسجل دخول مؤخراً') {
                return 'غير محدد';
            }
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return 'تاريخ غير صالح';
            }
            
            return new Intl.DateTimeFormat('ar-EG', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }
        
        function formatDateTime(dateString) {
            if (!dateString) {
                return 'غير محدد';
            }
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return 'تاريخ غير صالح';
            }
            
            return new Intl.DateTimeFormat('ar-EG', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            }).format(date);
        }
    </script>
</body>
</html>